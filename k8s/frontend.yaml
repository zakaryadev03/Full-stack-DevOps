apiVersion: v1
kind: Service
metadata:
  name: frontend-svc
  namespace: sre-lab
spec:
  selector:
    app: frontend
  ports:
    - protocol: TCP
      port: 80 # Nginx container port
      targetPort: 80 # Target container port
      nodePort: 30080 # External port to access on Minikube
  type: NodePort
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: frontend-html-cm
  namespace: sre-lab
data:
  # This is the entire HTML/JS file.
  # The <script> tag now has the correct paths.
  index.html: |
    <!DOCTYPE html>
    <html lang="en">
    <head>
      <meta charset="UTF-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <title>SRE Lab Frontend</title>
      <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 2em; background: #f9f9f9; }
        .container { background: #fff; padding: 2em; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); max-width: 800px; margin: 0 auto; }
        h1, h2 { color: #333; }
        .input-group { margin-bottom: 1.5em; }
        .input-group label { display: block; margin-bottom: .5em; font-weight: 500; }
        .input-group input { width: 100%; padding: 10px; box-sizing: border-box; border-radius: 4px; border: 1px solid #ccc; }
        button { background: #007aff; color: white; border: none; padding: 12px 18px; border-radius: 4px; cursor: pointer; margin-right: 5px; font-size: 14px; }
        button:hover { background: #0056b3; }
        pre { background: #222; color: #00f000; padding: 1em; border-radius: 4px; min-height: 200px; font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace; overflow-x: auto; white-space: pre-wrap; }
      </style>
    </head>
    <body>
      <div class="container">
        <h1>SRE Lab Frontend</h1>
        <div class="input-group">
          <label for="gatewayUrl">API Gateway URL (from Minikube):</label>
          <input type="text" id="gatewayUrlInput" placeholder="http://192.168.49.2:30007" style="width: 100%;">
        </div>
        <h2>Actions</h2>
        <button onclick="createOrder()">Create New Order (POST /api/orders)</button>
        <button onclick="getInventory()">Get Inventory (GET /api/inventory)</button>
        <button onclick="getUser()">Get Users (GET /api/users)</button>
        <h2>Log</h2>
        <pre id="log"></pre>
      </div>

      <script>
        function getGatewayUrl() {
          const url = document.getElementById('gatewayUrlInput').value;
          if (!url) {
            logMessage('ERROR: Please enter the API Gateway URL first.');
            return null;
          }
          return url.trim();
        }

        function logMessage(message) {
          document.getElementById('log').textContent += `> ${message}\n`;
        }

        async function createOrder() {
          const gatewayUrl = getGatewayUrl();
          if (!gatewayUrl) return;

          const item = 'item' + Math.floor(Math.random() * 3 + 1);
          const quantity = Math.floor(Math.random() * 5 + 1);
          const body = { item, quantity };
          
          logMessage(`Sending request to: ${gatewayUrl}/api/orders with body ${JSON.stringify(body)}`);
          
          try {
            // --- FIX 1: Correct path and method ---
            const response = await fetch(`${gatewayUrl}/api/orders`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(body)
            });

            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            logMessage('Response: ' + JSON.stringify(data, null, 2));
          } catch (error) {
            logMessage('Network Error: ' + error.message);
          }
        }

        async function getInventory() {
          const gatewayUrl = getGatewayUrl();
          if (!gatewayUrl) return;

          logMessage(`Sending request to: ${gatewayUrl}/api/inventory`);
          
          try {
            // --- FIX 2: Correct path ---
            const response = await fetch(`${gatewayUrl}/api/inventory`);
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            logMessage('Response: ' + JSON.stringify(data, null, 2));
          } catch (error) {
            logMessage('Network Error: ' + error.message);
          }
        }

        async function getUser() {
          const gatewayUrl = getGatewayUrl();
          if (!gatewayUrl) return;
          
          logMessage(`Sending request to: ${gatewayUrl}/api/users`);

          try {
            // --- FIX 3: Correct path ---
            const response = await fetch(`${gatewayUrl}/api/users`);
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            logMessage('Response: ' + JSON.stringify(data, null, 2));
          } catch (error) {
            logMessage('Network Error: ' + error.message);
          }
        }
      </script>
    </body>
    </html>
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: frontend-deploy
  namespace: sre-lab
spec:
  replicas: 1
  selector:
    matchLabels:
      app: frontend
  template:
    metadata:
      labels:
        app: frontend
    spec:
      containers:
        - name: nginx
          image: nginx:1.25-alpine # Use a small, stable nginx image
          ports:
            - containerPort: 80
          volumeMounts:
            - name: html-volume
              mountPath: /usr/share/nginx/html/index.html # Mount AS index.html
              subPath: index.html # Use the 'index.html' key from the ConfigMap
          resources:
            requests:
              memory: "64Mi"
              cpu: "250m"
            limits:
              memory: "128Mi"
              cpu: "500m"
      volumes:
        - name: html-volume
          configMap:
            name: frontend-html-cm # Point to our ConfigMap